{% extends "base-topmenu.html" %}
{% block title %}{{ block.super }} : {{ request.path }}{% endblock %}
{% block tail_head %}
<style type="text/css">
    body {
        padding: 10px;
    }
    img {
        width: 99%;
        height: auto;
    }
    /*select, button {
        vertical-align: top;
    }*/
    td {
        vertical-align: middle;
    }
    .viewpane {
        padding-left: 10px;
        border-left-style: solid;
        border-left-width: 1px;
        border-color: #ddd;
    }
    .viewobj {
        border-style: solid;
        border-width: 2px;
        border-color: #ddd;
    }
    .workpane {
        width: 99%;
        margin:0;
    }
    input[type='number']{
        padding: 0px;
        margin: 0px;
        width: 40px;
    }
    #map_container2 { height: 600px; width: 100%; border:2px;}
    img.olTileImage { max-width: 256px !important; }
</style>
{% endblock %}
{% block content %}
<div class="row-fluid">

<div class="span2"> 
    <h3>Search:</h3>

    <form>
        Year: 
        <input type="number" min="2006" step="1" value="2007"><br><br>
        Source:
        <select style="width: 100%">
            <option selected>AUV
            <option>BRUVs
            <option>Towed Video
        </select><br><br>
    	Campaign:
        <select name="campaignSelect" multiple="multiple" class="workpane" id="campaignSelect" onchange="selectCampaign($(this).val());">
        	<!-- Content inserted from jqery -->
        </select><br><br>
    	Deployments:
        <select name="deploymentSelect" multiple="multiple" class="workpane" id="deploymentSelect"  onchange="selectDeployment($(this).val());">
        	<!-- Content inserted from jqery -->
        </select><br><br>
        Depth Range: <strong id="selectedDepthMin"></strong> to <strong id="selectedDepthMax"></strong> m<br>
        <span id="depthMin"></span><span id="depthMax" style="float:right"></span><br>
		<div id="depthSlider" style="width:100%; height:5px"></div><br><br>
    </form>
    <div id="savecollection" class="well"> 
    	<p id="collection_info">Getting points...</p>
    	<a href="#" class="btn btn-primary btn-create-collection newCollection" 
    	   rel="popover" 
    	   data-html="true"
    	   id="newCollectionPopover" 
    	   data-content="Collection Name <input type='text' id='collection_name' name='collection_name' value='my new collection'><br><button class='btn btn-warning btn-create-collection pull-left' onclick='dismissPopover();'>Forget it</button><button class='btn btn-primary btn-create-collection pull-right' onclick='createCollection();'> Make it</button><br><p> </p>" 
    	   data-original-title="New Collection Options"> <i class="icon-plus-sign icon-2x pull-left"></i> Save As Collection</a>    
	</div>

</div>

<div class="span10 viewpane" >

    
    <ul class="nav nav-tabs">
        <li class="active"><a href="#map" data-toggle="tab">Map</a></li>
        <li><a href="#thm" data-toggle="tab">Thumbnails</a></li>
        <li><a href="#tax" data-toggle="tab">Taxonomy</a></li>
    </ul>


    <div class="tab-content">

        <div class="tab-pane active" id="map">
            {% include "webinterface/dataviews/mapview.html"%}
        </div>

        <div class="tab-pane" id="tax">
            {% include "webinterface/dataviews/taxonomytree.html"%}
        </div>
        
        <div class="tab-pane" id="thm">
            {% include "webinterface/dataviews/thumbnails.html"%}
        </div>
    </div>
</div>
</div>

{% endblock %}

{% block add_script %}
    <!-- TODO: make this find openlayers from assets -->
	
<script src="http://www.openlayers.org/dev/OpenLayers.js"></script>
	
<script type="text/javascript">

	var deployment_set_extent = [];
    var filter_array = [];
    var deploymentMap;
    var currentSelectedDeployments = [];
    
    
    $('.newCollection').popover({ html : true});

    function dismissPopover() {
	    $("#newCollectionPopover").popover('hide');
    }
    
    function setDepthRange(minDepth, maxDepth)
    {
  		$("#depthSlider").slider({
          range: true,
          min: minDepth,
          max: maxDepth,
          values: [ minDepth, maxDepth ],
          slide: function( event, ui ) {
            $( "#selectedDepthMin" ).html( ui.values[ 0 ] );
            $( "#selectedDepthMax" ).html( ui.values[ 1 ] );
         }
       });    	
	   $( "#depthMin" ).html(minDepth);
	   $( "#depthMax" ).html(maxDepth);
	   $( "#selectedDepthMin" ).html(minDepth);
	   $( "#selectedDepthMax" ).html(maxDepth);
    }
	function selectCampaign(id) {
		getDeploymentList(id);
		getNewImageList("limit=30&campaign="+id);
		//alert('Selected campaign id: '+id);
	}
	
	function selectDeployment(id) {
		getNewImageList("limit=30&deployment="+id);
		updateMapForSelectedDeployments(id);
		updateUIForDeploymentList(id);
	}
	
    function getDeploymentList(campaign_id) {
    
	    filter_array.length=0;
	    var deployment_ids = [];
	    
		var apiurl = "/api/dev/deployment/?format=json";
		
		// apply filter if campaign id is valid
		if (!isNaN(campaign_id) && campaign_id!="") {
			apiurl += "&campaign="+campaign_id;
		}
		
		$.getJSON(apiurl , function(deployment_list){
			//alert ('L: ' + j.objects.length);
			var options = '';
			for (var i = 0; i < deployment_list.objects.length; i++) {
				options += '<option value="' + deployment_list.objects[i].id + '">' + deployment_list.objects[i].short_name + '</option>';
				deployment_ids.push(deployment_list.objects[i].id);
			}

			$("#deploymentSelect").html(options);
			
	        updateMapForSelectedDeployments(deployment_ids);		

	        updateUIForDeploymentList(deployment_ids);
 			//$('#deploymentSelect option:first').attr('selected', 'selected');
		})
		
	}
	
	function getCampaignList() {
		var apiurl = "/api/dev/campaign/?format=json";
		$.getJSON(apiurl , function(campaigns){
			//alert ('L: ' + j.objects.length);
			var options = '<option value="">--ALL--</option>';
			for (var i = 0; i < campaigns.objects.length; i++) {
				options += '<option value="' + campaigns.objects[i].id + '">' + campaigns.objects[i].short_name + '</option>';
			}
			$("#campaignSelect").html(options);
			//$('#deploymentSelect option:first').attr('selected', 'selected');
		})
	}

	function updateMapForSelectedDeployments(deployment_ids){
			filter_array.length=0;
		    for (var i = 0; i < deployment_ids.length;i ++) {
				filter_array.push(new OpenLayers.Filter.Comparison({
		                type: OpenLayers.Filter.Comparison.EQUAL_TO,
		                property: "deployment_id",
		                value: deployment_ids[i]
	            }));
            }

			
			//reload map data for new deployment list
			var filter_1_1 = new OpenLayers.Format.Filter({version: "1.1.0"});
	        var filter_logic = new OpenLayers.Filter.Logical({
	            type: OpenLayers.Filter.Logical.OR,
	            filters: filter_array
	        });
            var xml = new OpenLayers.Format.XML(); 
            var new_filter = xml.write(filter_1_1.write(filter_logic));
            
	        var layer = deploymentMap.getLayersByName("Images")[0];
	        
	        layer.params['FILTER']  = new_filter;

	        layer.redraw();
		
	}
	
	function updateUIForDeploymentList(deployment_ids){
		$('.btn-create-collection').removeAttr('disabled');
		currentSelectedDeployments.length = 0;

		if(deployment_ids.length > 0) {
			$("#collection_info").text(deployment_ids.length+' deployments in the view');
			for  (var i = 0; i < deployment_ids.length;i ++) {
				currentSelectedDeployments.push(deployment_ids[i]);
			}
		} else {
		    $('.btn-create-collection').attr('disabled', 'disabled');
			$("#collection_info").text('Nothing being viewed');
		}
		//$('#savecollection').p("wee");
	}
	
	function createCollection() {
	 console.log($('#collectionName').val());
		var form = document.createElement('form');
		form.setAttribute('method', 'post');
		form.setAttribute('action', '{% url webinterface.views.create_collection_from_deployments %}');
		form.style.display = 'hidden';
		
		var hiddenField = document.createElement("input");
		hiddenField.setAttribute("type", "hidden");
		hiddenField.setAttribute("name", "deployment_ids");
		hiddenField.setAttribute("value", currentSelectedDeployments);
		form.appendChild(hiddenField);
		
		var hiddenField2 = document.createElement("input");
		hiddenField2.setAttribute("type", "hidden");
		hiddenField2.setAttribute("name", "collection_name");
		hiddenField2.setAttribute("value", $('#collection_name').val());
		form.appendChild(hiddenField2);
		
		document.body.appendChild(form)
		form.submit();
		
	}
	
	
    //need so the ajax queries can make it outside the projects domain and contact geoserver
    
    OpenLayers.ProxyHost = "/proxy/";

    $(document).ready(function(){
    
      	getDeploymentList();
  		getCampaignList();
  		setDepthRange(0, 500);     
  		
  		//Map view code to get moved out later.
        //prep some data we need to use to display the points
        var WMS_URL = "{{ WMS_URL }}";
        var WMSLayerName = "{{ WMS_layer_name }}";


        /* Filter based on the deployment id */

        var filter_1_1 = new OpenLayers.Format.Filter({version: "1.1.0"});
        filter = new OpenLayers.Filter.Logical({
            type: OpenLayers.Filter.Logical.OR,
            filters: filter_array
            /*[
                new OpenLayers.Filter.Comparison({
                    type: OpenLayers.Filter.Comparison.EQUAL_TO,
                    property: "deployment_id",
                    value: deploymentId
                })/*,
                 /*new OpenLayers.Filter.Comparison({
                 type: OpenLayers.Filter.Comparison.GREATER_THAN,
                 property: "depth",
                 value: "25"
                 })*//*,
                 new OpenLayers.Filter.Spatial({
                 type: OpenLayers.Filter.Spatial.BBOX,
                 value: new OpenLayers.Bounds(-180, -90, 180, 90),
                 projection: "EPSG:4326"
                 })
            ]*/
        });

        /* Setting up the projection details here, so that 4326 projected data can be displayed on top of
         * base layers that use the google projection */
        var xml = new OpenLayers.Format.XML();
        var geographic = new OpenLayers.Projection("EPSG:4326");
        var mercator = new OpenLayers.Projection("EPSG:900913");
        var world = new OpenLayers.Bounds(-180, -89, 180, 89).transform(
                geographic, mercator
        );

        //map setting based on projections
        var options = {
            projection: mercator,
            //displayProjection: geographic,
            units: "m",
            maxExtent: world,
            maxResolution: 156543.0399,
            numZoomLevels: 25
        };

        //map is assigned to the deployment-map div above
        deploymentMap = new OpenLayers.Map("deployment-map", options);

        /*set up the open street map base layers, need to set some extra resolution information here so that
         we can zoom beyond OSM's maximum zoom level of 18*/
        var osm = new OpenLayers.Layer.OSM(null, null, {
            resolutions: [156543.03390625, 78271.516953125, 39135.7584765625,
                19567.87923828125, 9783.939619140625, 4891.9698095703125,
                2445.9849047851562, 1222.9924523925781, 611.4962261962891,
                305.74811309814453, 152.87405654907226, 76.43702827453613,
                38.218514137268066, 19.109257068634033, 9.554628534317017,
                4.777314267158508, 2.388657133579254, 1.194328566789627,
                0.5971642833948135, 0.25, 0.1, 0.05],
            serverResolutions: [156543.03390625, 78271.516953125, 39135.7584765625,
                19567.87923828125, 9783.939619140625,
                4891.9698095703125, 2445.9849047851562,
                1222.9924523925781, 611.4962261962891,
                305.74811309814453, 152.87405654907226,
                76.43702827453613, 38.218514137268066,
                19.109257068634033, 9.554628534317017,
                4.777314267158508, 2.388657133579254,
                1.194328566789627, 0.5971642833948135],
            transitionEffect: 'resize',
            isBaseLayer:true,
            minZoomLevel: 1,
            maxZoomLevel: 25,
            numZoomLevels: 25,
            sphericalMercator: true
        });
        deploymentMap.addLayer(osm);

        //this is the layer for our points to be displayed with
        var imagePointsLayer = new OpenLayers.Layer.WMS( "Images",
                WMS_URL,
                {layers: WMSLayerName, transparent: "true", format: "image/png", filter: xml.write(filter_1_1.write(filter))},
                {isBaseLayer: false, minZoomLevel: 1, maxZoomLevel: 25, numZoomLevels: 25}
        );
        deploymentMap.addLayer(imagePointsLayer);

        //TODO: work out a better way to do this. This bounds code has a bad smell.
        var boundsArr = "(108, -10, 157, -46)".replace("(","").replace(")","").split(",");
        var bounds = new OpenLayers.Bounds();
        bounds.extend(new OpenLayers.LonLat(boundsArr[0], boundsArr[1]));
        bounds.extend(new OpenLayers.LonLat(boundsArr[2], boundsArr[3]));
        deploymentMap.zoomToExtent(bounds.transform(geographic, mercator));

        //popup window configuration that queries more information about a point that is clicked on
        var info = new OpenLayers.Control.WMSGetFeatureInfo({
            url: WMS_URL,
            title: 'Identify features by clicking',
            queryVisible: true,
            eventListeners: {
                getfeatureinfo: function(event) {
                    var popup = new OpenLayers.Popup.FramedCloud(
                            "Details",
                            deploymentMap.getLonLatFromPixel(event.xy),
                            new OpenLayers.Size(200,200),
                            event.text,
                            null,
                            true,
                            null
                    );
                    deploymentMap.addPopup(popup, true);
                }
            }
        });
        deploymentMap.addControl(info);
        info.activate();
        
        $('.btn-create-collection').attr('disabled', 'disabled');
        currentSelectedDeployments = [];
    });
</script>
{% endblock %}
