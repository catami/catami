{% extends "base-topmenu.html" %}
{% load waffle_tags %}

{% block title %}{{ block.super }} : {{ request.path }}{% endblock %}
{% block tail_head %}
    <style type="text/css">
        body {
            padding: 10px;
        }

        img {
            width: 99%;
            height: auto;
        }

            /*select, button {
                vertical-align: top;
            }*/
        td {
            vertical-align: middle;
        }

        .viewpane {
            padding-left: 10px;
            border-left-style: solid;
            border-left-width: 1px;
            border-color: #ddd;
        }

        .viewobj {
            border-style: solid;
            border-width: 2px;
            border-color: #ddd;
        }

        .workpane {
            width: 99%;
            margin: 0;
        }

        input[type='number'] {
            padding: 0px;
            margin: 0px;
            width: 40px;
        }

        #map_container2 {
            height: 600px;
            width: 100%;
            border: 2px;
        }

    </style>
{% endblock %}
{% block content %}
    <div class="row-fluid">

        <div class="span2">
            <h3>Search:</h3>

            <form>

                {% switch Experimental %}
                    Year:
                    <input type="number" min="2006" step="1" value="2007"><br>
                    <br>
                    Source:
                    <select style="width: 100%">
                        <option selected>AUV
                        <option>BRUVs
                        <option>Towed Video
                    </select>
                {% endswitch %}
                <br><br>
                Campaign:
                <select name="campaignSelect" multiple="multiple"
                        class="workpane" id="campaignSelect"
                        onchange="selectCampaign($(this).val());">
                    <!-- Content inserted from jqery -->
                </select><br><br>
                Deployments:
                <select name="deploymentSelect" multiple="multiple"
                        class="workpane" id="deploymentSelect"
                        onchange="selectDeployment($(this).val());">
                    <!-- Content inserted from jqery -->
                </select>
                <br><br>
                {% switch Experimental %}
                    Depth Range: <strong id="selectedDepthMin"></strong> to
                    <strong id="selectedDepthMax"></strong> m
                    <br>
                    <span id="depthMin"></span>
                    <span id="depthMax" style="float:right"></span><br>
                    <div id="depthSlider" style="width:100%; height:5px"></div>
                    <br><br>
                {% endswitch %}
            </form>

            {% comment %}{% switch Collections %}
                <div id="savecollection" class="well">
                    <p id="collection_info">Getting points...</p>
                    <a href="#" class="btn btn-primary btn-create-collection newCollection"
                       rel="popover"
                       data-html="true"
                       id="newCollectionPopover"
                       data-content="<div id='collection_options'>Collection Name <input type='text' id='collection_name' value='my new collection'><br><button class='btn btn-warning btn-create-collection pull-left' onclick='dismissPopover();'>Forget it</button><button class='btn btn-primary btn-create-collection pull-right' onclick='createCollection();'> Make it</button><br><p> </p></div>"
                       data-original-title="New Collection Options"> <i class="icon-plus-sign icon-2x pull-left"></i>
                        Save
                        As Collection</a>
                </div>
            {% endswitch %}{% endcomment %}
        </div>

        <div id="CreateProjectModal" class="modal hide fade">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"
                        aria-hidden="true">&times;</button>
                <h3>Create Project</h3>
            </div>
            <div class="modal-body">
                <div id='collection_options' style='z-index:3002'>Project Name
                    <input type='text' id='collection_name' value='My Project'><br>
                </div>
            </div>
            <div class="modal-footer">
                <button class='btn btn-primary btn-create-collection pull-right'
                        onclick='createCollection();'> Ok
                </button>
            </div>
        </div>

        <div class="span10 viewpane">

            <ul class="nav nav-tabs">
                <li class="active"><a href="#map" data-toggle="tab"><i
                        class="icon-globe"></i> Map</a></li>
                <li><a href="#thm" data-toggle="tab"><i
                        class="icon-eye-open"></i> Images</a></li>
                {% switch Experimental %}
                    <li><a href="#tax" data-toggle="tab">Taxonomy</a></li>
                {% endswitch %}

                <a href="#CreateProjectModal" class="btn btn-primary pull-right btn-create-collection newCollection" data-toggle="modal"><i class="icon-list-alt"></i> Create Project </a></a>

            </ul>


            <div class="tab-content">

                <div class="tab-pane active" id="map">
                    {% include "webinterface/dataviews/mapview.html" %}
                </div>

                {% switch Experimental %}
                    <div class="tab-pane" id="tax">
                        {% include "webinterface/dataviews/taxonomytree.html" %}
                    </div>
                {% endswitch %}

                <div class="tab-pane" id="thm">
                    {% include "webinterface/dataviews/thumbnails.html" %}
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block add_script %}

    <script type="text/javascript">

        var currentSelectedDeployments = [];

        $('.newCollection').popover({ html: true});

        function dismissPopover() {
            $("#newCollectionPopover").popover('hide');
        }

        function setDepthRange(minDepth, maxDepth) {
            $("#depthSlider").slider({
                range: true,
                min: minDepth,
                max: maxDepth,
                values: [ minDepth, maxDepth ],
                slide: function (event, ui) {
                    $("#selectedDepthMin").html(ui.values[ 0 ]);
                    $("#selectedDepthMax").html(ui.values[ 1 ]);
                }
            });
            $("#depthMin").html(minDepth);
            $("#depthMax").html(maxDepth);
            $("#selectedDepthMin").html(minDepth);
            $("#selectedDepthMax").html(maxDepth);
        }
        function selectCampaign(id) {
            getDeploymentList(id);
            getNewImageList("limit=30&campaign=" + id);
            //alert('Selected campaign id: '+id);
        }

        function selectDeployment(id) {
            getNewImageList("limit=30&deployment=" + id);
            updateMapForSelectedDeployments(id);
            updateUIForDeploymentList(id);
        }

        function getDeploymentList(campaign_id) {

            filter_array.length = 0;
            var deployment_ids = [];

            var apiurl = "/api/dev/deployment/?format=json";

            // apply filter if campaign id is valid
            if (!isNaN(campaign_id) && campaign_id != "") {
                apiurl += "&campaign=" + campaign_id;
            }

            $.getJSON(apiurl, function (deployment_list) {
                //alert ('L: ' + j.objects.length);
                var options = '';
                for (var i = 0; i < deployment_list.objects.length; i++) {
                    options += '<option value="' + deployment_list.objects[i].id + '">' + deployment_list.objects[i].short_name + '</option>';
                    deployment_ids.push(deployment_list.objects[i].id);
                }

                $("#deploymentSelect").html(options);

                updateMapForSelectedDeployments(deployment_ids);

                updateUIForDeploymentList(deployment_ids);
                //$('#deploymentSelect option:first').attr('selected', 'selected');
            })

        }

        function getCampaignList() {
            var apiurl = "/api/dev/campaign/?format=json";
            $.getJSON(apiurl, function (campaigns) {
                //alert ('L: ' + j.objects.length);
                var options = '<option value="">--ALL--</option>';
                for (var i = 0; i < campaigns.objects.length; i++) {
                    options += '<option value="' + campaigns.objects[i].id + '">' + campaigns.objects[i].short_name + '</option>';
                }
                $("#campaignSelect").html(options);
                //$('#deploymentSelect option:first').attr('selected', 'selected');
            })
        }

        function updateUIForDeploymentList(deployment_ids) {
            $('.btn-create-collection').removeAttr('disabled');
            currentSelectedDeployments.length = 0;

            if (deployment_ids.length > 0) {
                $("#newCollectionPopover").popover('enable');

                $("#collection_info").text(deployment_ids.length + ' deployments in the view');
                for (var i = 0; i < deployment_ids.length; i++) {
                    currentSelectedDeployments.push(deployment_ids[i]);
                }

                updateMapExtent();

            } else {
                $("#newCollectionPopover").popover('disable');
                $('.btn-create-collection').attr('disabled', 'disabled');
                $("#collection_info").text('Nothing being viewed');
            }
            //$('#savecollection').p("wee");
        }

        function createCollection() {
            var colname = $('#collection_name').val();
            $("#collection_options").html("<div id='create_collection_spinner'><i class='icon-refresh icon-spin icon-3x pull-left'></i> <p>I'm making your new collection. This will take a little while.</p></div>");

            var form = document.createElement('form');
            form.setAttribute('method', 'post');
            form.setAttribute('action', '{% url webinterface.views.create_collection_from_deployments %}');
            form.style.display = 'hidden';

            var hiddenField = document.createElement("input");
            hiddenField.setAttribute("type", "hidden");
            hiddenField.setAttribute("name", "deployment_ids");
            hiddenField.setAttribute("value", currentSelectedDeployments);
            form.appendChild(hiddenField);

            var hiddenField2 = document.createElement("input");
            hiddenField2.setAttribute("type", "hidden");
            hiddenField2.setAttribute("name", "collection_name");
            hiddenField2.setAttribute("value", colname);
            form.appendChild(hiddenField2);


            document.body.appendChild(form)
            form.submit();
        }

        function updateMapExtent() {
            $.ajax({
                type: "POST",
                url: '{% url webinterface.views.get_multiple_deployment_extent %}',
                data: "deployment_ids=" + currentSelectedDeployments,
                success: function (response, textStatus, jqXHR) {
                    var boundsArr = response.extent.replace("(", "").replace(")", "").split(",");
                    var bounds = new OpenLayers.Bounds();
                    bounds.extend(new OpenLayers.LonLat(boundsArr[0], boundsArr[1]));
                    bounds.extend(new OpenLayers.LonLat(boundsArr[2], boundsArr[3]));
                    var geographic = new OpenLayers.Projection("EPSG:4326");
                    var mercator = new OpenLayers.Projection("EPSG:900913");
                    deploymentMap.zoomToExtent(bounds.transform(geographic, mercator));
                }
            });
        }

        $(document).ready(function () {

            getDeploymentList();
            getCampaignList();
            setDepthRange(0, 500);
            initDeploymentMap();

        });
    </script>
{% endblock %}
