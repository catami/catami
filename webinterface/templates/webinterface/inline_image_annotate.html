{% extends "base-newimageview.html" %}

{% block content %}

<div class="container-fluid" style="padding-left:0px;padding-right:0px;">
	<div class="row-fluid">
		<div class="span9">
			<div class="row-fluid" align="center">
				{% comment %}<div id = "image-decorators">
					<p><button>prev</button>title<button>next</button></p>
				</div>	{% endcomment %}
			    <div class="row-fluid">
				    <div id="imageFrame" style="margin:10px 0px;">
				        <img id="image"/>
				    </div>
				    <div id="pointDetails" style="display:none; height: 200px; width: 300px;">
				        <h4><i class="icon-tag"></i> Annotation Details</h4>
				        <table cellpadding="3" id="annotationInfo">
				            <tr><td><b>Label :</b></td><td id="annotationLabel">Label</td></tr>
				            <tr><td><b>CAAB code: </b></td><td id="annotationCaab">CAAB code</td></tr>
				            <tr><td><b>Description: </b></td><td id="annotationDescription">Show some useful information from the database here</td></tr>
				        </table>
				    </div>
				</div>
		    </div>
	    </div>
		<div class="span3">

            <div class="row-fluid" id="labelRow">
                <h4> Image Labels </h4>
                <!--<div id="ImageLabels" class="ImageLabels">
                 	<span class="label label-success"> This image is yet to be labelled. </span>
                </div>
                -->
                <ul class="nav nav-pills ImageLabels">
                    <li class="active">
                        <a>This image is yet to be labelled.</a>
                    </li>
                </ul>
            </div>

			<div class="row-fluid">
		        <h4> Label Selection</h4>
                <div class="well well-small">
                    <b> Tip: </b> Select a point in the image to the left, then select a label from the list below.
                </div>
			    <input type="text" id="KeywordSearchText" class="input-medium search-query input-block-level" style="width:100%;" placeholder="Refine list with name/keyword" autocomplete="off" />
		        <div style="margin-top:10px;margin-bottom:10px;overflow:auto;" id="annotation_list_view">
		            <small>
		                <table class="table table-striped table-bordered table-condensed" id="label-list">
		                <!-- JS -->
		                </table>
		            </small>
		        </div>
		    </div>
		</div>
	</div>
</div>

{% endblock %}
{% block add_script %}
    <script type="text/javascript" src="{{ STATIC_URL }}assets/catami-api/js/annotations.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}assets/catami-api/js/thumbnails.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}assets/jquery/plugins/delayed-keyup.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}assets/jquery/plugins/jquery.imagesloaded.min.js"></script>
    
    <script type="text/javascript">

        var taglist = new AnnotationAPI({
            config: {
                format: '<tr><td><a href="#" onclick="labelSelectedPoints(\'{[resource_uri]}\');" rel="label-popover" data-placement="leftTop" data-html="true"'+
                        'data-content="<b>CAAB Code:</b> {[caab_code]}<br>{[description]}" data-original-title="{[code_name]}">{[code_name]}</a></td></tr>'
            }
        });

        var imgobj = new ImageAPI();
        var thmlist = new ThumnailAPI({
            config: {
                theme: 'th-catamiviewer',
                format: '<li><a href="/inlineimageannotate/{id}/?offset={itemoffset}&apistring={apistringviewer}&asid={{ annotation_id }}" ><img height="96px" width="72px" src="{thumbnail_location}" /></a></li>'
            }
        });

        var pointList = [];

        /**
         *
         */
        function selectAnnotationPoint(event) {
            //var id = event.srcElement.id;
            var selectedPoint = event.target;
            var isSelected = false;
            for (var i = 0; i < pointList.length; i++) {
            	if (pointList[i].cssid == selectedPoint.id) {
                    if (pointList[i].selected == true) {
			            selectedPoint.src = (pointList[i].scored)
                                ? '{{ STATIC_URL }}images/annotationPointOverlayScored.png'
                                : '{{ STATIC_URL }}images/annotationPointOverlay.png';
			            pointList[i].selected = false;
		            } else {
                        pointList[i].selected = true;
			            selectedPoint.src = ( '{{ STATIC_URL }}images/annotationPointOverlaySelected.png' );
		                $('#KeywordSearchText').focus();
		            }
                }
            }
        }

        /**
         *
         */
        function showAnnotationDetails(event) {
            var id = event.target.id;
            for (var i = 0; i < pointList.length; i++) {
                if (pointList[i].cssid === event.target.id) {
                    var selectedPoint = pointList[i];
                    break;
                }
            }

            var sameLabelPointList = new Array();
            sameLabelPointList.push(selectedPoint);
            //get all other points which have the same label
            for (var i = 0; i < pointList.length; i++) {
                if (pointList[i].label == selectedPoint.label) {
                    sameLabelPointList.push(pointList[i]);
                }
            }
            for (var i = 0; i < sameLabelPointList.length; i++) {
                if (sameLabelPointList[i].scored == true)
                {
                    /*
                    $('#pointDetails').css({
                        left: event.pageX + 10,
                        top: event.pageY,
                        position: 'absolute'
                    });
                    $('#annotationInfo #annotationLabel').html(selectedPoint.label);
                    $('#annotationInfo #annotationCaab').html(selectedPoint.value);
                    $('#annotationInfo #annotationDescription').html('Show some useful information from the database here');
                    $('#pointDetails').fadeIn(500); */
                    $("."+sameLabelPointList[i].cssid).tooltip('show');
                }
            }
        }

        /**
         *
         */
        function hideAnnotationDetails() {
        	var id = event.target.id;
            for (var i = 0; i < pointList.length; i++) {
                if (pointList[i].cssid === event.target.id) {
                    var selectedPoint = pointList[i];
                    break;
                }
            }

            var sameLabelPointList = new Array();
            sameLabelPointList.push(selectedPoint);
            //get all other points which have the same label
            for (var i = 0; i < pointList.length; i++) {
                if (pointList[i].label == selectedPoint.label) {
                    sameLabelPointList.push(pointList[i]);
                }
            }
            for (var i = 0; i < sameLabelPointList.length; i++) {
                if (sameLabelPointList[i].scored == true)
                {
                    $("."+sameLabelPointList[i].cssid).tooltip('destroy');
                }
            }
        }

        /**
         *
         */
        function setAnnotationPoints() {
            //$("#imagePointFrame").empty();
            //$('#imagePointFrame').find('*').not('#image').remove();

            var imageElement = $('#image').clone();
            $("#imageFrame").empty();
            imageElement.appendTo('#imageFrame');

            $.each(pointList, function(i,thispoint) {
                var imgsrc = (thispoint.scored)
                        ? '{{ STATIC_URL }}images/annotationPointOverlayScored.png'
                        : '{{ STATIC_URL }}images/annotationPointOverlay.png';
                var img = $('<img>');
                img.attr('id', thispoint.cssid);
                img.attr('class', thispoint.cssid);
                img.css('top', thispoint.y*$('#image').height());
                img.css('left', thispoint.x*$('#image').width());
                img.attr('onmouseover', 'showAnnotationDetails(event)');
                img.attr('onmouseout', 'hideAnnotationDetails(event)');
                img.attr('onclick', 'selectAnnotationPoint(event)');
                img.attr('src', imgsrc);
                img.attr('selected', false);
                img.attr('data-toggle', 'tooltip');
                img.attr('title', getReadableLabel(thispoint.label));
                img.appendTo('#imageFrame');
            });

            updateImageLabelsSidebar();
        }

        /**
         *
         */
        function moveAnnotationPoints() {
            $.each(pointList, function(i,thispoint) {
                var imgpoint = $('#'+thispoint.cssid);
                imgpoint.css('top',thispoint.y*$('#image').height());
                imgpoint.css('left',thispoint.x*$('#image').width());
            });
        }

        /**
         *
         * @param label
         * @param value
         */
        function labelSelectedPoints(label) {
            //'{ "objects": [{"resource_uri": "/api/dev/point_annotation/2/", "label": "/api/dev/annotation_code/273/"}]}'
            var patchdata = {objects: []};
            var selectedinds = [];
            var patchpoints = false;
            for (var i = 0; i < pointList.length; i++) {
                if (pointList[i].selected == true) {
                    patchdata.objects.push({resource_uri: pointList[i].resource_uri, label: label});
                    patchpoints = true;
                    selectedinds.push(i);
                    console.log(i+': '+pointList[i].selected);
                    //pointList[i].code_name = code_name;
                }
            }
            if (patchpoints) {
                $.ajax({
                    url: '/api/dev/point_annotation/',
                    type: 'PATCH',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify(patchdata),
                    success: function(response, textStatus, jqXhr) {
                        for (var i=0 ; i<selectedinds.length ; i++) {
                            $('#'+pointList[selectedinds[i]].cssid).attr('src','{{ STATIC_URL }}images/annotationPointOverlayScored.png');
                            pointList[selectedinds[i]].selected = false;
                            pointList[selectedinds[i]].scored = true;
                            pointList[selectedinds[i]].label = label;
                        }

                        setAnnotationPoints();
                        updateImageLabelsSidebar();

                        for (var i=0 ; i<selectedinds.length ; i++) {
                            //show a quick popup to say we have labelled these points
                            $("."+pointList[selectedinds[i]].cssid).tooltip('show');
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.log(XMLHttpRequest);
                        show_note('Error','There was an error while processing your request: '+errorThrown, 'error');
                        setAnnotationPoints();
                        updateImageLabelsSidebar();
                    }
                });
            }

        }

        function getReadableLabel(resourceUri) {
            for(var i =0; i < taglist.annotationCodeList.length; i++) {
                if(taglist.annotationCodeList[i].resource_uri == resourceUri)
                    return taglist.annotationCodeList[i].code_name;
            }

            return resourceUri;
        }

        /**
         * Shows what has been annotated in an image
         */
        function updateImageLabelsSidebar() {
            var labelList = [];
            for (var i = 0; i < pointList.length; i++) {
                if(pointList[i].scored == true) {

                    //if no list item exists for this scored label then create it
                    if(labelList[pointList[i].label] == null) {
                        labelList[pointList[i].label] = 1;//{label: pointList[i].label, count: 1};

                    }
                    //if it does exist, then increment the number for the given label
                    else {
                        //labelList[pointList[i].label].count = labelList[pointList[i].label].count + 1;
                        labelList[pointList[i].label] = labelList[pointList[i].label] + 1;
                    }
                }
            }

            //now we have the labels and numbers, print them
            if(Object.keys(labelList).length > 0)
                $(".ImageLabels").empty();

            for (var label in labelList) {
                var labelReadableName = '';

                labelReadableName = getReadableLabel(label);

                $(".ImageLabels").append("<li class='active'> <a>"+labelReadableName+" <span class='badge badge-info'><b>"+ labelList[label] +"</b></span> </a> </li>");
            }
				resolveFullHeight();


        }

        // add clear button to search field
        $("#clear").click(function(evt){
		    evt.preventDefault();
		    $("#KeywordSearchText").val("").focus();
		});
        
        function resolveFullHeight() {

			//Keeps the 
        	$("#annotation_list_view").css("height", "auto");

		    var estimatedFooterHeight = 20;
		
		    var imageview_fullHeight = (-1 * ($("#imageFrame").position().top - $(window).height()))-estimatedFooterHeight;
		    var tableview_fullHeight = (-1 * ($("#annotation_list_view").position().top - $(window).height()))-estimatedFooterHeight;

            $("#annotation_list_view").height(tableview_fullHeight);
		}


		resolveFullHeight();

        $(document).ready(function () {
            imgobj.getImage({{ image_id }}, '#image');
            taglist.getNewTags('limit=999','#label-list');
            $("[rel=label-popover]").popover({ trigger: "hover" });

            pointList = taglist.getAnnotationPoints('image={{ image_id }}&annotation_set={{ annotation_id }}&limit=0');

            //note: you can't called load() on images (works sometimes on Safari/Chrome, never on Firefox). 
            //		Read the jquery docs mb ie: http://api.jquery.com/load-event/
            //imagesLoaded() is a jquery plugin replacement that handles the various browser cases.
            
            $("#image").imagesLoaded(function() {
	             setAnnotationPoints(pointList);
            });
            
            $(window).resize(function(e){
            	resolveFullHeight();
            	moveAnnotationPoints(pointList);
            });
            //thmlist.appendThumnails('#thumbnailpane','{{ apistring|safe }}');

            // Select input field contents on focus
            $('#KeywordSearchText').focus(function(){
                this.select();
            });
            $("#KeywordSearchText").onDelayedKeyup({
                handler: function() {
                    var searchwords = $(this).val().split(' ');
                    var searchstr = '';
                    $.each (searchwords, function(i,word) {
                        searchstr += '&code_name__icontains='+word;
                    });
                    taglist.getNewTags('limit=999'+searchstr,'#label-list');
                    $("[rel=label-popover]").popover({ trigger: "hover" });
                },
                delay: 500
            });


        });
    </script>
{% endblock %}


 
