{% extends "base-newimageview.html" %}

{% block content %}

<div class="container-fluid" style="padding-left:0px;padding-right:0px;">
	<div class="row-fluid">
		<div class="span9">
			<div class="row-fluid" align="center">
				<div id = "image-decorators">
					<p><button>prev</button>title<button>next</button></p>
				</div>	
			    <div class="row-fluid">
				    <div id="imageFrame" style="margin:10px;">
				        <img id="image"/>
				    </div>
				    <div id="pointDetails" style="display:none; height: 200px; width: 300px;">
				        <h4><i class="icon-tag"></i> Annotation Details</h4>
				        <table cellpadding="3" id="annotationInfo">
				            <tr><td><b>Label :</b></td><td id="annotationLabel">Label</td></tr>
				            <tr><td><b>CAAB code: </b></td><td id="annotationCaab">CAAB code</td></tr>
				            <tr><td><b>Description: </b></td><td id="annotationDescription">Show some useful information from the database here</td></tr>
				        </table>
				    </div>
				</div>
		    </div>
	    </div>
		<div class="span3">
			<div class="row-fluid">
		        <h3><i class="icon-pencil"></i> Annotation Selection</h3>
			    
			    <input type="text" id="KeywordSearchText" class="input-medium search-query input-block-level" style="width:100%;" placeholder="Refine list with name/keyword" autocomplete="off" />
		        <div style="margin-top:10px;margin-bottom:10px;overflow:auto;" id="annotation_list_view">
		            <small>
		                <table class="table table-striped table-bordered table-condensed" id="label-list">
		                <!-- JS -->
		                </table>
		            </small>
		        </div>
		    </div>
		</div>
	</div>
</div>

{% endblock %}
{% block add_script %}
    <script type="text/javascript" src="{{ STATIC_URL }}assets/catami-api/js/annotations.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}assets/catami-api/js/thumbnails.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}assets/jquery/plugins/delayed-keyup.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}assets/jquery/plugins/jquery.imagesloaded.min.js"></script>
    
    <script type="text/javascript">

        var taglist = new AnnotationAPI({
            config: {
                format: '<tr><td><a href="#" onclick="labelSelectedPoints(\'{[resource_uri]}\');" rel="label-popover" data-placement="leftTop" data-html="true"'+
                        'data-content="<b>CAAB Code:</b> {[caab_code]}<br>{[description]}" data-original-title="{[code_name]}">{[code_name]}</a></td></tr>'
            }
        });

        var imgobj = new ImageAPI();
        var thmlist = new ThumnailAPI({
            config: {
                theme: 'th-catamiviewer',
                format: '<li><a href="/inlineimageannotate/{id}/?offset={itemoffset}&apistring={apistringviewer}&asid={{ annotation_id }}" ><img height="96px" width="72px" src="{thumbnail_location}" /></a></li>'
            }
        });

        var pointList = [];
        //var selectedPoints = [];

        /**
         *
         */
        function selectAnnotationPoint() {
            //var id = event.srcElement.id;
            var selectedPoint = event.srcElement;
            var isSelected = false;
            for (var i = 0; i < pointList.length; i++) {
            	if (pointList[i].cssid == selectedPoint.id) {
                    if (pointList[i].selected == true) {
			            selectedPoint.src = (pointList[i].scored)
                                ? '{{ STATIC_URL }}images/annotationPointOverlayScored.png'
                                : '{{ STATIC_URL }}images/annotationPointOverlay.png';
			            pointList[i].selected = false;
		            } else {
                        pointList[i].selected = true;
			            selectedPoint.src = ( '{{ STATIC_URL }}images/annotationPointOverlaySelected.png' );
		                $('#KeywordSearchText').focus();
		            }
                }
            }
        }

        /**
         *
         */
        function showAnnotationDetails() {
            var id = event.srcElement.id;
            for (var i = 0; i < pointList.length; i++) {
                if (pointList[i].cssid === event.srcElement.id) {
                    var selectedPoint = pointList[i];
                    break;
                }
            }
            //var selectedPoint = event.srcElement;
            if (selectedPoint.scored == true)
            {
	            $('#pointDetails').css({
	                left: event.pageX + 10,
	                top: event.pageY,
	                position: 'absolute'
	            });
                $('#annotationInfo #annotationLabel').html(selectedPoint.label);
                $('#annotationInfo #annotationCaab').html(selectedPoint.value);
                $('#annotationInfo #annotationDescription').html('Show some useful information from the database here');
                $('#pointDetails').fadeIn(500);
            }
        }

        /**
         *
         */
        function hideAnnotationDetails() {
        	$('#pointDetails').fadeOut(250);
        }

        /**
         *
         */
        function setAnnotationPoints() {
            $.each(pointList, function(i,thispoint) {
                var imgsrc = (thispoint.scored)
                        ? '{{ STATIC_URL }}images/annotationPointOverlayScored.png'
                        : '{{ STATIC_URL }}images/annotationPointOverlay.png';
                var img = $('<img>');
                img.attr('id', thispoint.cssid);
                img.css('top', thispoint.y*$('#image').height());
                img.css('left', thispoint.x*$('#image').width());
                img.attr('onmouseover', 'showAnnotationDetails()');
                img.attr('onmouseout', 'hideAnnotationDetails()');
                img.attr('onclick', 'selectAnnotationPoint()');
                img.attr('src', imgsrc);
                img.attr('selected', false);
                img.appendTo('#imageFrame');
            });
        }

        /**
         *
         */
        function moveAnnotationPoints() {
            $.each(pointList, function(i,thispoint) {
                var imgpoint = $('#'+thispoint.cssid);
                imgpoint.css('top',thispoint.y*$('#image').height());
                imgpoint.css('left',thispoint.x*$('#image').width());
            });
        }

        /**
         *
         * @param label
         * @param value
         */
        function labelSelectedPoints(label) {
            //'{ "objects": [{"resource_uri": "/api/dev/point_annotation/2/", "label": "/api/dev/annotation_code/273/"}]}'
            var patchdata = {objects: []};
            var selectedinds = [];
            var patchpoints = false;
            for (var i = 0; i < pointList.length; i++) {
                if (pointList[i].selected == true) {
                    patchdata.objects.push({resource_uri: pointList[i].resource_uri, label: label});
                    patchpoints = true;
                    selectedinds.push(i);
                    console.log(i+': '+pointList[i].selected);
                }
            }
            if (patchpoints) {
                $.ajax({
                    url: '/api/dev/point_annotation/',
                    type: 'PATCH',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify(patchdata),
                    success: function(response, textStatus, jqXhr) {
                        for (var i=0 ; i<selectedinds.length ; i++) {
                            $('#'+pointList[selectedinds[i]].cssid).attr('src','{{ STATIC_URL }}images/annotationPointOverlayScored.png');
                            pointList[selectedinds[i]].selected = false;
                            pointList[selectedinds[i]].scored = true;
                            pointList[selectedinds[i]].label = label;
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.log(XMLHttpRequest);
                        show_note('Error','There was an error while processing your request: '+errorThrown, 'error');
                    }
                });
            }
        }


        // add clear button to search field
        $("#clear").click(function(evt){
		    evt.preventDefault();
		    $("#KeywordSearchText").val("").focus();
		});
        
        function resolveFullHeight() {
        
        	console.log('apparent view size',$(document).height(),$("#label-list").position().top,$("#imageFrame").position().top);
        	//$("#imageFrame").css("height", "auto");
        	$("#image").css("height", "auto");
        	//$("#image").css("width", "auto");

        	$("#annotation_list_view").css("height", "auto");

		    var estimatedFooterHeight = 20;
		
		    var imageview_fullHeight = (-1 * ($("#imageFrame").position().top - $(window).height()))-estimatedFooterHeight;
		    var tableview_fullHeight = (-1 * ($("#annotation_list_view").position().top - $(window).height()))-estimatedFooterHeight;

		    //$("#imageFrame").height(imageview_fullHeight);
		    $("#image").height(imageview_fullHeight);

            $("#annotation_list_view").height(tableview_fullHeight);
            console.log('computed size',imageview_fullHeight, tableview_fullHeight, $(document).height());
		}


		resolveFullHeight();


/*
		$(window).resize(function () {
		    resolveFullHeight();
		});
*/
/*
		function loadThumbnails(worksetId) {
            var url = "/api/dev/image/?limit=300&collection=" + worksetId;
            $.ajax({
                dataType: "json",
                async: true,
                url: url,
                success: function (img) {
                    var html = "<ul class='span1'>";
                    if (img.objects.length > 0) {
                        for (var i = 0; i < img.objects.length; i++) {
                            html += "<ul><a href='#' class='thumbnail'><img src='"+img.objects[i].thumbnail_location+"' data-src='"+img.objects[i].thumbnail_location+"' alt=''></a></ul>";
                         }
                    }
                    html += "</ul>"
                    $(".thumbnails").append(html);
                 }
            });

        }
*/

        $(document).ready(function () {
            imgobj.getImage({{ image_id }}, '#image');
            taglist.getNewTags('limit=999','#label-list');
            $("[rel=label-popover]").popover({ trigger: "hover" });

            pointList = taglist.getAnnotationPoints('image={{ image_id }}&annotation_set={{ annotation_id }}&limit=0');

            //note: you can't called load() on images. Read the jquery docs mb ie: http://api.jquery.com/load-event/
            //imagesLoaded() is a jquery plugin
            $("#image").imagesLoaded(function() {
	             setAnnotationPoints(pointList);
            });
            
            $(window).resize(function(e){
            	resolveFullHeight();
            	moveAnnotationPoints(pointList);
            });
            //thmlist.appendThumnails('#thumbnailpane','{{ apistring|safe }}');

            // Select input field contents on focus
            $('#KeywordSearchText').focus(function(){
                this.select();
            });
            $("#KeywordSearchText").onDelayedKeyup({
                handler: function() {
                    var searchwords = $(this).val().split(' ');
                    var searchstr = '';
                    $.each (searchwords, function(i,word) {
                        searchstr += '&code_name__icontains='+word;
                    });
                    taglist.getNewTags('limit=999'+searchstr,'#label-list');
                    $("[rel=label-popover]").popover({ trigger: "hover" });
                },
                delay: 500
            });


        });
    </script>
{% endblock %}


 
