{% extends "base-topmenu.html" %}

{% load waffle_tags %}
{% load force_extras %}

{% block tail_head %}
    <link rel="stylesheet" href="{{ STATIC_URL }}assets/css/leaflet.css" />
    <link rel="stylesheet" href="{{ STATIC_URL }}assets/css/Control.MiniMap.css" />


    <style>
    .leaflet-control-zoom-fullscreen { background-image: url({{ STATIC_URL }}assets/css/images/icon-fullscreen.png); }
    .leaflet-control-zoom-fullscreen.last { margin-top: 5px }
    #leaflet_container:-webkit-full-screen { width: 100% !important; height: 100% !important; }
    #leaflet_container:-moz-full-screen { width: 100% !important; height: 100% !important; }
    #leaflet_container:full-screen { width: 100% !important; height: 100% !important; }
    .info {
    padding: 0px 8px;
    align: right;
    font: 14px/16px Helvetica, Arial, sans-serif;
    background: white;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
    }
    .legend {
    text-align: left;
    line-height: 18px;
    color: #555;
    }
    .legend i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
    }
    </style>

{% endblock %}

{% block content %}

    {% if auvdeployment_object %}
        <div class="row-fluid">
            <div id='deployment-map' style="width:100%;height:430px;"></div>
        </div>
        <div class="row-fluid">
            <div class="span4"><div id="placeholder_01" style="width:100%;height:100px"></div></div>
            <div class="span4"><div id="placeholder_02" style="width:100%;height:100px"></div></div>
            <div class="span4"><div id="placeholder_03" style="width:100%;height:100px"></div></div>
        </div>

        <!--
            <div class="row-fluid">
                <a href="./images" class="btn btn-primary">Data Table</a>
            </div>
        -->

        {% switch Collections %}
        <br>
        <button type="button" class="btn btn-large btn-primary" onclick="convert();">Add to My Collections</button>
        {% endswitch %}

    {% endif %}

{% endblock %}

{% block add_script %}
    <script src='{{ STATIC_URL }}assets/js/excanvas.min.js'> </script>
    <script src='{{ STATIC_URL }}assets/js/leaflet.js'> </script>
    <script src='{{ STATIC_URL }}assets/js/Control.MiniMap.js'> </script>
    <script src='{{ STATIC_URL }}assets/js/rainbowvis.js'> </script>
    <script src='{{ STATIC_URL }}assets/js/jquery.flot.js'> </script>
    <script src='{{ STATIC_URL }}assets/js/jquery.flot.resize.js'></script>
    <script src='{{ STATIC_URL }}assets/js/Control.FullScreen.js'></script>
    <script src='{{ STATIC_URL }}assets/js/jquery.flot.axislabels.js'></script>

    <!-- TODO: make this find openlayers from assets -->
    <script src="http://www.openlayers.org/dev/OpenLayers.js"></script>

    <script type="text/javascript">

        //need so the ajax queries can make it outside the projects domain and contact geoserver
        OpenLayers.ProxyHost = "/proxy/";

        $(document).ready(function(){
            //prep some data we need to use to display the points
            var WMS_URL = "{{ WMS_URL }}";
            var WMSLayerName = "{{ WMS_layer_name }}";
            var deploymentId = "{{ deployment_id }}";

            /* Filter based on the deployment id */
            var filter_1_1 = new OpenLayers.Format.Filter({version: "1.1.0"});
            filter = new OpenLayers.Filter.Logical({
                type: OpenLayers.Filter.Logical.AND,
                filters: [
                    new OpenLayers.Filter.Comparison({
                        type: OpenLayers.Filter.Comparison.EQUAL_TO,
                        property: "deployment_id",
                        value: deploymentId
                    })/*,
                     /*new OpenLayers.Filter.Comparison({
                     type: OpenLayers.Filter.Comparison.GREATER_THAN,
                     property: "depth",
                     value: "25"
                     })*//*,
                     new OpenLayers.Filter.Spatial({
                     type: OpenLayers.Filter.Spatial.BBOX,
                     value: new OpenLayers.Bounds(-180, -90, 180, 90),
                     projection: "EPSG:4326"
                     })*/
                ]
            });

            /* Setting up the projection details here, so that 4326 projected data can be displayed on top of
             * base layers that use the google projection */
            var xml = new OpenLayers.Format.XML();
            var geographic = new OpenLayers.Projection("EPSG:4326");
            var mercator = new OpenLayers.Projection("EPSG:900913");
            var world = new OpenLayers.Bounds(-180, -89, 180, 89).transform(
                    geographic, mercator
            );

            //map setting based on projections
            var options = {
                projection: mercator,
                //displayProjection: geographic,
                units: "m",
                maxExtent: world,
                maxResolution: 156543.0399,
                numZoomLevels: 25
            };

            //map is assigned to the deployment-map div above
            var deploymentMap = new OpenLayers.Map("deployment-map", options);

            /*set up the open street map base layers, need to set some extra resolution information here so that
             we can zoom beyond OSM's maximum zoom level of 18*/
            var osm = new OpenLayers.Layer.OSM(null, null, {
                resolutions: [156543.03390625, 78271.516953125, 39135.7584765625,
                    19567.87923828125, 9783.939619140625, 4891.9698095703125,
                    2445.9849047851562, 1222.9924523925781, 611.4962261962891,
                    305.74811309814453, 152.87405654907226, 76.43702827453613,
                    38.218514137268066, 19.109257068634033, 9.554628534317017,
                    4.777314267158508, 2.388657133579254, 1.194328566789627,
                    0.5971642833948135, 0.25, 0.1, 0.05],
                serverResolutions: [156543.03390625, 78271.516953125, 39135.7584765625,
                    19567.87923828125, 9783.939619140625,
                    4891.9698095703125, 2445.9849047851562,
                    1222.9924523925781, 611.4962261962891,
                    305.74811309814453, 152.87405654907226,
                    76.43702827453613, 38.218514137268066,
                    19.109257068634033, 9.554628534317017,
                    4.777314267158508, 2.388657133579254,
                    1.194328566789627, 0.5971642833948135],
                transitionEffect: 'resize',
                isBaseLayer:true,
                minZoomLevel: 1,
                maxZoomLevel: 25,
                numZoomLevels: 25,
                sphericalMercator: true
            });
            deploymentMap.addLayer(osm);

            //this is the layer for our points to be displayed with
            var imagePointsLayer = new OpenLayers.Layer.WMS( "Images",
                    WMS_URL,
                    {layers: WMSLayerName, transparent: "true", format: "image/png", filter: xml.write(filter_1_1.write(filter))},
                    {isBaseLayer: false, minZoomLevel: 1, maxZoomLevel: 25, numZoomLevels: 25}
            );
            deploymentMap.addLayer(imagePointsLayer);

            //TODO: work out a better way to do this. This bounds code has a bad smell.
            var boundsArr = "{{ deployment_extent }}".replace("(","").replace(")","").split(",");
            var bounds = new OpenLayers.Bounds();
            bounds.extend(new OpenLayers.LonLat(boundsArr[0], boundsArr[1]));
            bounds.extend(new OpenLayers.LonLat(boundsArr[2], boundsArr[3]));
            deploymentMap.zoomToExtent(bounds.transform(geographic, mercator));

            //popup window configuration that queries more information about a point that is clicked on
            var info = new OpenLayers.Control.WMSGetFeatureInfo({
                url: WMS_URL,
                title: 'Identify features by clicking',
                queryVisible: true,
                eventListeners: {
                    getfeatureinfo: function(event) {
                        var popup = new OpenLayers.Popup.FramedCloud(
                                "Details",
                                deploymentMap.getLonLatFromPixel(event.xy),
                                new OpenLayers.Size(200,200),
                                event.text,
                                null,
                                true,
                                null
                        );
                        deploymentMap.addPopup(popup, true);
                    }
                }
            });
            deploymentMap.addControl(info);
            info.activate();
        });


    </script>

    <script type="text/javascript">
        $(function () {
            var d1 = [];
            var d2 = [];
            var d3 = [];

            {% comment %}var d1 = [{% for value in depth_data %}{% if not forloop.last %}[{{forloop.counter}},{{value}}],{% else %}[{{forloop.counter}},{{value}}]{% endif %}{% endfor %}]
            var d2 = [{% for value in salinity_data %}{% if not forloop.last %}[{{forloop.counter}},{{value}}],{% else %}[{{forloop.counter}},{{value}}]{% endif %}{% endfor %}]
            var d3 = [{% for value in temperature_data %}{% if not forloop.last %}[{{forloop.counter}},{{value}}],{% else %}[{{forloop.counter}},{{value}}]{% endif %}{% endfor %}]
            {% endcomment %}

            var d1 = JSON.parse("{{ depth_data }}");
            var d2 = JSON.parse("{{ salinity_data }}");
            var d3 = JSON.parse("{{ temperature_data }}");

            $.plot($("#placeholder_01"), [
                {
                    data:d1,
                    lines: { show: true, fill: true },
                    shadowSize:0
                }
            ],{yaxes: [{axisLabel: 'Depth (m)'}],grid: {borderWidth:0}});

            $.plot($("#placeholder_02"), [
                {
                    data:d2,
                    lines: { show: true, fill: false },
                    shadowSize:0
                }
            ],{yaxes: [{axisLabel: 'Salinity'}],grid: {borderWidth:0}});

            $.plot($("#placeholder_03"), [
                {
                    data:d3,
                    lines: { show: true, fill: false },
                    shadowSize:0
                }
            ],{yaxes: [{axisLabel: 'Temp (C)'}],grid: {borderWidth:0}});


        });
    </script>

{% endblock %}