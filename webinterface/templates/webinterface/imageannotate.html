{% extends "webinterface/imageview.html" %}

{% block imageview %}
    <div id="imageFrame">
        <img id="image"/>
    </div>
    <div id="pointDetails" style="display:none; height: 200px; width: 300px;">
        <h4><i class="icon-tag"></i> Annotation Details</h4>
        <table cellpadding="3" id="annotationInfo">
            <tr><td><b>Label :</b></td><td id="annotationLabel">Label</td></tr>
            <tr><td><b>CAAB code: </b></td><td id="annotationCaab">CAAB code</td></tr>
            <tr><td><b>Description: </b></td><td id="annotationDescription">Show some useful information from the database here</td></tr>
        </table>
    </div>
{% endblock %}

{% block leftpane %}
    <a href="#" class="btn" rel="popover-roll" data-placement="right" style="padding:7px; width:20px;" data-html="true"
       data-content="<img src='{{ STATIC_URL }}images/simple_annotate.png' width='100%' alt='Map'><p>This will be optionally pinnable to the side so that it is always viewable.</p>"
       data-original-title="Map info"><i class="icon-globe"></i></a><br>
    <a href="#" class="btn" rel="popover-roll" data-placement="right" style="padding:7px; width:20px;" data-html="true"
       data-content="<img src='{{ STATIC_URL }}images/mini-divedata.png' width='100%' alt='Map'><p>This will be optionally pinnable to the side so that it is always viewable.</p>"
       data-original-title="Image information"><i class="icon-info-sign"></i></a><br>
    <a href="#" class="btn" rel="popover-roll" data-placement="right" style="padding:7px; width:20px;" data-html="true"
       data-content="<img src='{{ STATIC_URL }}images/pie14.png' width='100%' alt='Map'><p>This will be optionally pinnable to the side so that it is always viewable.</p>"
       data-original-title="Class distribution"><i class="icon-bar-chart"></i></a><br>
{% endblock %}

{% block rightpane %}
    <div class="well infopane">
        <h1><i class="icon-tag"></i> Annotate <a class="pull-right" href="#" rel="tooltip" data-placement="left"
                                                 title="Type a class name/keyword to filter the list of options."><i
                class="icon-question-sign"></i></a></h1>


            <input type="text" id="KeywordSearchText" class="input-medium search-query" style="width:210px;" placeholder="Type name/keyword" autocomplete="off">

        <div class="divfixedh400">
            <small>
                <table class="table table-striped" id="label-list">
                <!-- JS -->
                </table>
            </small>
        </div>
    </div>
{% endblock %}

{% block rightfootpane %}
    <a href="#" class="btn disabled" style="width: 60px;margin: 0;" title="View"><i
            class="icon-eye-open"></i><br>View</a>
    <a href="{% url webinterface.views.image_annotate image_id %}?offset={{ offset }}&apistring={{ apistring|urlencode }}" class="btn btn-inverse" style="width: 60px;margin: 0;"
       title="Annotate"><i class="icon-tag"></i><br>Annotate</a>
    <a href="#" class="btn disabled" style="width: 60px;margin: 0;" title="Edit"><i
            class="icon-edit"></i><br>Edit</a>
{% endblock %}

{% block add_script %}
    <script type="text/javascript" src="{{ STATIC_URL }}assets/catami-api/js/annotations.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}assets/catami-api/js/thumbnails.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}assets/jquery/plugins/delayed-keyup.js"></script>
    <script type="text/javascript">

        var taglist = new AnnotationAPI({
            config: {
                format: '<tr><td><a href="#" onclick="labelSelectedPoints(\'{[resource_uri]}\');" rel="label-popover" data-placement="leftTop" data-html="true"'+
                        'data-content="<b>CAAB Code:</b> {[caab_code]}<br>{[description]}" data-original-title="{[code_name]}">{[code_name]}</a></td></tr>'
            }
        });

        var imgobj = new ImageAPI();
        var thmlist = new ThumnailAPI({
            config: {
                theme: 'th-catamiviewer',
                format: '<a class="th-catamiviewer" href="/imageannotate/{id}/?offset={itemoffset}&apistring={apistringviewer}&asid={{ annotation_id }}" ><img src="{thumbnail_location}" /></a>'
            }
        });

        var pointList = [];
        //var selectedPoints = [];

        /**
         *
         */
        function selectAnnotationPoint() {
            //var id = event.srcElement.id;
            var selectedPoint = event.srcElement;
            var isSelected = false;
            for (var i = 0; i < pointList.length; i++) {
            	if (pointList[i].cssid == selectedPoint.id) {
                    if (pointList[i].selected == true) {
			            selectedPoint.src = (pointList[i].scored)
                                ? '{{ STATIC_URL }}images/annotationPointOverlayScored.png'
                                : '{{ STATIC_URL }}images/annotationPointOverlay.png';
			            pointList[i].selected = false;
		            } else {
                        pointList[i].selected = true;
			            selectedPoint.src = ( '{{ STATIC_URL }}images/annotationPointOverlaySelected.png' );
		                $('#KeywordSearchText').focus();
		            }
                }
            }
        }

        /**
         *
         */
        function showAnnotationDetails() {
            var id = event.srcElement.id;
            for (var i = 0; i < pointList.length; i++) {
                if (pointList[i].cssid === event.srcElement.id) {
                    var selectedPoint = pointList[i];
                    break;
                }
            }
            //var selectedPoint = event.srcElement;
            if (selectedPoint.scored == true)
            {
	            $('#pointDetails').css({
	                left: event.pageX + 10,
	                top: event.pageY,
	                position: 'absolute'
	            });
                $('#annotationInfo #annotationLabel').html(selectedPoint.label);
                $('#annotationInfo #annotationCaab').html(selectedPoint.value);
                $('#annotationInfo #annotationDescription').html('Show some useful information from the database here');
                $('#pointDetails').fadeIn(500);
            }
        }

        /**
         *
         */
        function hideAnnotationDetails() {
        	$('#pointDetails').fadeOut(250);
        }

        /**
         *
         */
        function setAnnotationPoints() {
            $.each(pointList, function(i,thispoint) {
                var imgsrc = (thispoint.scored)
                        ? '{{ STATIC_URL }}images/annotationPointOverlayScored.png'
                        : '{{ STATIC_URL }}images/annotationPointOverlay.png';
                var img = $('<img>');
                img.attr('id', thispoint.cssid);
                img.css('top', thispoint.y*$('#image').height());
                img.css('left', thispoint.x*$('#image').width());
                img.attr('onmouseover', 'showAnnotationDetails()');
                img.attr('onmouseout', 'hideAnnotationDetails()');
                img.attr('onclick', 'selectAnnotationPoint()');
                img.attr('src', imgsrc);
                img.attr('selected', false);
                img.appendTo('#imageFrame');
            });
        }

        /**
         *
         */
        function moveAnnotationPoints() {
            $.each(pointList, function(i,thispoint) {
                var imgpoint = $('#'+thispoint.cssid);
                imgpoint.css('top',thispoint.y*$('#image').height());
                imgpoint.css('left',thispoint.x*$('#image').width());
            });
        }

        /**
         *
         * @param label
         * @param value
         */
        function labelSelectedPoints(label) {
            //'{ "objects": [{"resource_uri": "/api/dev/point_annotation/2/", "label": "/api/dev/annotation_code/273/"}]}'
            var patchdata = {objects: []};
            var selectedinds = [];
            var patchpoints = false;
            for (var i = 0; i < pointList.length; i++) {
                if (pointList[i].selected == true) {
                    patchdata.objects.push({resource_uri: pointList[i].resource_uri, label: label});
                    patchpoints = true;
                    selectedinds.push(i);
                    console.log(i+': '+pointList[i].selected);
                }
            }
            if (patchpoints) {
                $.ajax({
                    url: '/api/dev/point_annotation/',
                    type: 'PATCH',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify(patchdata),
                    success: function(response, textStatus, jqXhr) {
                        for (var i=0 ; i<selectedinds.length ; i++) {
                            $('#'+pointList[selectedinds[i]].cssid).attr('src','{{ STATIC_URL }}images/annotationPointOverlayScored.png');
                            pointList[selectedinds[i]].selected = false;
                            pointList[selectedinds[i]].scored = true;
                            pointList[selectedinds[i]].label = label;
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.log(XMLHttpRequest);
                        show_note('Error','There was an error while processing your request: '+errorThrown, 'error');
                    }
                });
            }
        }

        /**
         *
         */
        /*
        function generateAnnotationPoints() {

            // Number of points and minimum separation.  These should be parameters for the point selection
            var numPoints = 50;
            // the list of points for this image.  This should eventually be put into the database and checked
            // for the image when loaded
            for (var i = 0; i < numPoints; i++) {
                // need to make sure the spacing of points is not too close
                // the point locations also need to be pushed into the database
                var newPoint = {x: -1, y: -1, id: -1};
                var imWidth = 1; //$('#image').width();
                var imHeight = 1; //$('#image').height();
                newPoint.x = Math.random() * imWidth; //Math.round(Math.random() * imWidth) - 5;
                newPoint.y = Math.random() * imHeight; //Math.round(Math.random() * imHeight) - 5;
                newPoint.id = 'AnnotionPoint' + i;
                pointList.push(newPoint);
            }

            pointList = taglist.getAnnotationPoints('image={{ image_id }}&annotation_set={{ annotation_id }}&limit=0');
            //console.log(pointList);
        }*/

        $(document).ready(function () {

            imgobj.getImage({{ image_id }}, '#image');
            taglist.getNewTags('limit=999','#label-list');
            $("[rel=label-popover]").popover({ trigger: "hover" });

            //generateAnnotationPoints();
            pointList = taglist.getAnnotationPoints('image={{ image_id }}&annotation_set={{ annotation_id }}&limit=0');
            $("#image").one("load", function() {
                setAnnotationPoints(pointList);
            });
            //$('#image').load(setAnnotationPoints(pointList));
            $(window).resize(function(e){moveAnnotationPoints(pointList)});
            thmlist.appendThumnails('#thumbnailpane','{{ apistring|safe }}');

            // Select input field contents on focus
            $('#KeywordSearchText').focus(function(){
                this.select();
            });
            $("#KeywordSearchText").onDelayedKeyup({
                handler: function() {
                    var searchwords = $(this).val().split(' ');
                    var searchstr = '';
                    $.each (searchwords, function(i,word) {
                        searchstr += '&code_name__icontains='+word;
                    });
                    taglist.getNewTags('limit=999'+searchstr,'#label-list');
                    $("[rel=label-popover]").popover({ trigger: "hover" });
                },
                delay: 500
            });

            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    function getCookie(name) {
                        var cookieValue = null;
                        if (document.cookie && document.cookie != '') {
                            var cookies = document.cookie.split(';');
                            for (var i = 0; i < cookies.length; i++) {
                                var cookie = jQuery.trim(cookies[i]);
                                // Does this cookie string begin with the name we want?
                                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                    break;
                                }
                            }
                        }
                        return cookieValue;
                    }
                    if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                        // Only send the token to relative URLs i.e. locally.
                        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                    }
                }
            });


        });
    </script>
{% endblock %}


 
